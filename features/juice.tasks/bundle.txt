--- tasks.schema.acl ---
:::ACL_METADATA
DOMAIN: juice.tasks
CONTEXT: Schema
VERSION: 1.0.0
:::

SCHEMA Task {
  DESCRIPTION: "A trackable unit of work with priority, ownership, and lifecycle state."

  ATTRIBUTES:
    id: uuid required generated immutable
      DESCRIPTION: "Globally unique identifier assigned at creation."
    title: string required min(1) max(200)
      DESCRIPTION: "Short summary describing the work to be done."
    description: string optional max(4000)
      DESCRIPTION: "Detailed explanation, acceptance criteria, or notes."
    status: enum(todo, in_progress, done, archived) required default(todo)
      DESCRIPTION: "Lifecycle state governing task visibility and available transitions."
    priority: enum(low, medium, high, urgent) required default(medium)
      DESCRIPTION: "Relative importance used for sorting and triage."
    assignee: string optional max(64)
      DESCRIPTION: "Display name of the person responsible for this task."
    dueDate: date optional
      DESCRIPTION: "Target completion date. Null means no deadline."
    createdAt: datetime required generated immutable
    updatedAt: datetime required generated

  CONSTRAINTS:
    - A task with status=archived is not resolvable by public list contracts.
    - Status transitions follow: todo -> in_progress -> done -> archived.
    - Only admin may archive or delete tasks belonging to other users.

  IMMUTABLE:
    - id
    - createdAt
}


--- tasks.flow.acl ---
:::ACL_METADATA
DOMAIN: juice.tasks
CONTEXT: Flow
VERSION: 1.0.0
:::

FLOW PrepareNewTask {
  DESCRIPTION: "Validates input and applies initial state for newly created tasks."
  TRIGGER: Contract.CreateTask
  STEPS:
    1. Enforce Schema.Task.title is non-empty.
    2. Set status=todo when no explicit status provided.
    3. Set priority=medium when no explicit priority provided.
    4. Stamp createdAt/updatedAt.
}

FLOW TransitionStatus {
  DESCRIPTION: "Validates and applies a task status change, enforcing allowed transitions."
  TRIGGER: Contract.ChangeStatus
  REQUIRES:
    - Transition must follow allowed path: todo -> in_progress -> done -> archived.
  STEPS:
    1. Validate requested status is a legal transition from current status.
    2. Set Schema.Task.status to requested value.
    3. Stamp updatedAt.
    4. Emit DomainEvent task.status_changed.
}

FLOW ArchiveCompletedTask {
  DESCRIPTION: "Moves a completed task to archived state, removing it from active views."
  TRIGGER: Contract.ArchiveTask
  REQUIRES:
    - Schema.Task.status == done
  STEPS:
    1. Set status=archived.
    2. Stamp updatedAt.
    3. Emit DomainEvent task.archived.
}

FLOW DetectOverdue {
  DESCRIPTION: "Flags tasks whose due date has passed without reaching done status."
  TRIGGER: Internal.DailySchedule
  REQUIRES:
    - Schema.Task.dueDate < now
    - Schema.Task.status != done
    - Schema.Task.status != archived
  STEPS:
    1. Emit DomainEvent task.overdue for each matching task.
}

FLOW SoftDeleteTask {
  DESCRIPTION: "Marks a task as removed. Data is retained for audit but hidden from all views."
  TRIGGER: Contract.DeleteTask
  STEPS:
    1. Set status=archived.
    2. Stamp updatedAt.
    3. Emit DomainEvent task.deleted.
}

FLOW TouchUpdatedAt {
  DESCRIPTION: "Keeps the updatedAt timestamp current on any task mutation."
  TRIGGER: Schema.Task.updated
  STEPS:
    1. Set updatedAt=now.
}


--- tasks.contract.acl ---
:::ACL_METADATA
DOMAIN: juice.tasks
CONTEXT: Contract
VERSION: 1.0.0
REQUIRES:
  - acl.identity.UserDirectory@^1.0 AS Identity
:::

CONTRACT CreateTask {
  DESCRIPTION: "Creates a new task with default todo status."
  INPUT:
    - title
    - description
    - priority
    - assignee
    - dueDate
  AUTHZ:
    - admin:any
    - member:any
  LOGIC: |
    1. EXECUTE Flow.PrepareNewTask
    2. PERSIST Schema.Task
    3. EMIT task.created
  INTERFACE:
    - REST: POST /tasks
}

CONTRACT EditTask {
  DESCRIPTION: "Updates mutable fields on an existing task."
  INPUT:
    - title
    - description
    - priority
    - dueDate
  AUTHZ:
    - admin:any
    - member:self
  LOGIC: |
    1. UPDATE mutable Schema.Task fields only
    2. EMIT task.updated
  INTERFACE:
    - REST: PATCH /tasks/{id}
}

CONTRACT ChangeStatus {
  DESCRIPTION: "Transitions a task to a new lifecycle status."
  INPUT:
    - status
  AUTHZ:
    - admin:any
    - member:self
  LOGIC: |
    1. EXECUTE Flow.TransitionStatus
  INTERFACE:
    - REST: POST /tasks/{id}/status
}

CONTRACT AssignTask {
  DESCRIPTION: "Sets or clears the assignee on a task."
  INPUT:
    - assignee
  AUTHZ:
    - admin:any
    - member:self
  LOGIC: |
    1. CALL Identity.ResolveUser with assignee
    2. SET Schema.Task.assignee
    3. EMIT task.assigned
  INTERFACE:
    - REST: POST /tasks/{id}/assign
}

CONTRACT ArchiveTask {
  DESCRIPTION: "Archives a completed task, removing it from active lists."
  INPUT:
    - taskId
  AUTHZ: admin
  LOGIC: |
    1. REQUIRES Schema.Task.status == done
    2. EXECUTE Flow.ArchiveCompletedTask
  INTERFACE:
    - REST: POST /tasks/{id}/archive
}

CONTRACT DeleteTask {
  DESCRIPTION: "Soft-deletes a task by archiving it. Data retained for audit."
  INPUT:
    - taskId
  AUTHZ: admin
  LOGIC: |
    1. EXECUTE Flow.SoftDeleteTask
  INTERFACE:
    - REST: DELETE /tasks/{id}
}

CONTRACT TasksAPI {
  DESCRIPTION: "Read-only endpoints for listing and retrieving tasks."
  LOGIC: |
    1. GET /tasks returns list of non-archived tasks with status/priority/assignee filters.
    2. GET /tasks/{id} returns single task if requester is admin or assignee.
  INTERFACE:
    - REST: GET /tasks
    - REST: GET /tasks/{id}
}


--- tasks.persona.acl ---
:::ACL_METADATA
DOMAIN: juice.tasks
CONTEXT: Persona
VERSION: 1.0.0
:::

PERSONA Admin {
  DESCRIPTION: "Project lead or manager who oversees all tasks across the team."

  VIEW TaskBoard {
    DESCRIPTION: "Paginated list of all tasks with filtering, sorting, and bulk actions."
    DISPLAY:
      - title as primary sortable
      - status as badge filterable
      - priority as badge filterable
      - assignee filterable
      - dueDate sortable
      - createdAt as relative-date sortable
    ACTIONS:
      - "Open Task" -> Contract.TasksAPI(detail)
      - "Change Status" -> Contract.ChangeStatus
      - "Assign" -> Contract.AssignTask
      - "Archive" -> Contract.ArchiveTask
      - "Delete" -> Contract.DeleteTask
  }

  VIEW TaskEditor {
    DESCRIPTION: "Form views for creating new tasks and editing existing task details."
    DISPLAY:
      - form.create: [title, description, priority, assignee, dueDate]
      - form.edit: [title, description, priority, dueDate]
    ACTIONS:
      - "Create Task" -> Contract.CreateTask
      - "Save Changes" -> Contract.EditTask
      - "Assign" -> Contract.AssignTask
  }
}

PERSONA Member {
  DESCRIPTION: "Team member who manages their own assigned tasks."

  VIEW MyTasks {
    DESCRIPTION: "Filtered view showing only tasks assigned to the current user."
    DISPLAY:
      - title as primary sortable
      - status as badge filterable
      - priority as badge filterable
      - dueDate sortable
      - updatedAt as relative-date sortable
    ACTIONS:
      - "Open Task" -> Contract.TasksAPI(detail)
      - "Change Status" -> Contract.ChangeStatus
  }

  VIEW TaskEditor {
    DESCRIPTION: "Form for creating tasks and editing own task details."
    DISPLAY:
      - form.create: [title, description, priority, dueDate]
      - form.edit: [title, description, priority, dueDate]
    ACTIONS:
      - "Create Task" -> Contract.CreateTask
      - "Save Changes" -> Contract.EditTask
  }
}
